# Лабораторна робота: Масштабування Electric Monitor (Node.js/Express.js) в Kubernetes

## Мета роботи
Показати як можна масштабувати бекенд системи Electric Monitor (Node.js + Express.js + MongoDB + MQTT) для роботи з великим навантаженням, провести навантажувальне тестування та проаналізувати результати.

## Підготовка

### 1. Встановлення необхідних інструментів
```powershell
# Встановлення Python та pip (якщо не встановлені)
# Завантажте з https://www.python.org/downloads/

# Встановлення Locust для навантажувального тестування
pip install locust

# Перевірка встановлення
locust --version
```

### 2. Підготовка Electric Monitor застосунку
```powershell
# Переконайтеся, що Docker образ зібрано
.\scripts\build.ps1

# Перевірте наявність образу
docker images electric-monitor

# Переконайтеся, що .env файл містить правильний MongoDB URI
# (буде використовуватися зовнішній MongoDB Atlas)
```

### 3. Перевірка Kubernetes кластера
```powershell
# Переконайтеся, що Kubernetes кластер запущено (Docker Desktop)
kubectl cluster-info

# Перевірте доступні вузли
kubectl get nodes
```

## Особливості тестування Electric Monitor API

### Тестові endpoints:
1. **Health Check (`/health`)** - основний endpoint для перевірки продуктивності
2. **Аутентифікація** - реєстрація та авторизація користувачів
3. **Управління пристроями** - створення та отримання пристроїв
4. **Дані потужності** - робота з даними моніторингу електрики
5. **Алерти** - система сповіщень

### Навантажувальне тестування симулює:
- **1000 одночасних користувачів**
- **25 користувачів/секунда з'являються**
- **Реальні API сценарії** (реєстрація → авторизація → робота з пристроями)
- **3 хвилини тестування** для кожної конфігурації

## Виконання лабораторної роботи

### Крок 1: Налаштування середовища
```powershell
# Розгорніть застосунок в Kubernetes
.\scripts\load-testing.ps1 -Action setup
```

### Крок 2: Тестування з 1 подом
```powershell
# Тест з одним подом
.\scripts\load-testing.ps1 -Action 1
```

### Крок 3: Тестування з 2 подами
```powershell
# Масштабування до 2 подів та тестування
.\scripts\load-testing.ps1 -Action 2
```

### Крок 4: Тестування з 3 подами
```powershell
# Масштабування до 3 подів та тестування
.\scripts\load-testing.ps1 -Action 3
```

### Крок 5: Автоматичне тестування всіх конфігурацій
```powershell
# Запуск всіх тестів підряд
.\scripts\load-testing.ps1 -Action test
```

## Перевірка масштабування

### Команди для моніторингу
```powershell
# Перегляд подів
kubectl get pods -n electric-monitor

# Перегляд сервісів
kubectl get services -n electric-monitor

# Перегляд логів
kubectl logs -f deployment/electric-monitor-api -n electric-monitor

# Моніторинг ресурсів
kubectl top pods -n electric-monitor
```

### Ручне масштабування
```powershell
# Масштабування до N реплік
kubectl scale deployment electric-monitor-api --replicas=N -n electric-monitor

# Перевірка статусу розгортання
kubectl rollout status deployment/electric-monitor-api -n electric-monitor
```

## Аналіз результатів

### Результати тестування зберігаються в папці `test-results/`:
- `report_Npods_timestamp.html` - HTML звіт з графіками
- `results_Npods_timestamp.csv` - CSV файл з детальними результатами

### Ключові метрики для аналізу:
1. **RPS (Requests Per Second)** - кількість оброблених запитів за секунду
2. **Response Time** - час відгуку (середній, медіана, 95-й процентиль)
3. **Failure Rate** - відсоток невдалих запитів
4. **Resource Usage** - використання CPU та пам'яті

### Таблиця для заповнення результатів:
| Кількість подів | RPS | Середній відгук (мс) | Max відгук (мс) | Помилки | Висновки |
|-----------------|-----|---------------------|-----------------|---------|----------|
| 1               |     |                     |                 |         |          |
| 2               |     |                     |                 |         |          |
| 3               |     |                     |                 |         |          |

## Очищення
```powershell
# Видалення всіх ресурсів після завершення роботи
.\scripts\load-testing.ps1 -Action cleanup
```

## Очікувані результати
- Зростання RPS при збільшенні кількості подів
- Зниження часу відгуку при горизонтальному масштабуванні
- Виявлення вузьких місць системи
- Аналіз ефективності LoadBalancer в Kubernetes

## Технічні деталі реалізації Electric Monitor

### Архітектура системи:
1. **Node.js + Express.js** - основний API сервер
2. **MongoDB Atlas** - зовнішня база даних (з .env файлу)
3. **MQTT брокер** - для IoT пристроїв (ESP32)
4. **JWT авторизація** - система аутентифікації
5. **Docker контейнери** - упакування застосунку

### API Endpoints для тестування:
- `GET /health` - перевірка здоров'я системи
- `GET /` - кореневий endpoint
- `POST /api/auth/register` - реєстрація користувача
- `POST /api/auth/login` - авторизація
- `GET /api/auth/profile` - профіль користувача
- `GET /api/devices` - список пристроїв
- `POST /api/devices` - створення пристрою
- `GET /api/alerts` - отримання алертів

### Стратегія масштабування:
- **Горизонтальне масштабування** - збільшення кількості Node.js подів
- **Stateless архітектура** - кожен под Express.js незалежний
- **Зовнішнє зберігання стану** - MongoDB Atlas та MQTT брокер
- **Load Balancer** - Kubernetes Service розподіляє навантаження

## Структура звіту

### 1. Опис стратегії масштабування системи
Описати горизонтальне масштабування Electric Monitor API з використанням Kubernetes Deployment та LoadBalancer Service.

### 2. Опис технічних рішень
Пояснити як Node.js + Express.js архітектура дозволяє масштабування, роль MongoDB Atlas та MQTT брокера.

### 3. Опис навантажувальних тестів
Детально описати тестування з Locust: 1000 користувачів, 25 користувачів/сек, 3 хвилини на кожну конфігурацію.

### 4. Аналіз результатів навантаження
Проаналізувати RPS, latency та інші метрики для 1, 2 та 3 подів.

### 5. Аналіз вузьких місць
Ідентифікувати обмеження системи (MongoDB Atlas, MQTT брокер, мережа).

## Висновки
Підсумувати ефективність масштабування Electric Monitor в Kubernetes та рекомендації для покращення продуктивності.